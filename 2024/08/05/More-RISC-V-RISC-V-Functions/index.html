<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>More RISC-V,RISC-V Functions | Vks🐱</title><meta name="author" content="Vks"><meta name="copyright" content="Vks"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Review of Last Lecture RISC Design Principles  Smaller is faster: 32 registers, fewer instructions Keep it simple: rigid syntax   RISC-V Registers: s0-s11, t0-t6, x0  No data types, just ** **, operat">
<meta property="og:type" content="article">
<meta property="og:title" content="More RISC-V,RISC-V Functions">
<meta property="og:url" content="http://example.com/2024/08/05/More-RISC-V-RISC-V-Functions/index.html">
<meta property="og:site_name" content="Vks🐱">
<meta property="og:description" content="Review of Last Lecture RISC Design Principles  Smaller is faster: 32 registers, fewer instructions Keep it simple: rigid syntax   RISC-V Registers: s0-s11, t0-t6, x0  No data types, just ** **, operat">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/VksAvatar.png">
<meta property="article:published_time" content="2024-08-05T14:48:47.000Z">
<meta property="article:modified_time" content="2024-08-05T15:00:25.109Z">
<meta property="article:author" content="Vks">
<meta property="article:tag" content="cs61c">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/VksAvatar.png"><link rel="shortcut icon" href="/img/Vksicon.png"><link rel="canonical" href="http://example.com/2024/08/05/More-RISC-V-RISC-V-Functions/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'More RISC-V,RISC-V Functions',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-05 23:00:25'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img" style="background-image:url(/img/VksAvatar.png);background-repeat: no-repeat;background-position:center;"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = 'hidden';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}

preloader.initLoading()
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/source/css/preload_change.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/VksAvatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Vks🐱"><span class="site-name">Vks🐱</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">More RISC-V,RISC-V Functions</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-05T14:48:47.000Z" title="发表于 2024-08-05 22:48:47">2024-08-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-05T15:00:25.109Z" title="更新于 2024-08-05 23:00:25">2024-08-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cs61c/">cs61c</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="More RISC-V,RISC-V Functions"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Review-of-Last-Lecture"><a href="#Review-of-Last-Lecture" class="headerlink" title="Review of Last Lecture"></a>Review of Last Lecture</h1><ul>
<li><p>RISC Design Principles</p>
<ul>
<li>Smaller is faster: 32 registers, fewer instructions</li>
<li>Keep it simple: rigid syntax</li>
</ul>
</li>
<li><p>RISC-V Registers: <code>s0-s11, t0-t6, x0</code></p>
<ul>
<li>No data types, just ** **, operations determine how they are interpreted</li>
</ul>
</li>
<li><p>Memory is byte-addressed</p>
<ul>
<li>no types → no automatic pointer arithmetic</li>
</ul>
</li>
<li><p>RISC-V Instructions</p>
<ul>
<li>Arithmetic: <code>add, sub, addi, mult, div</code></li>
<li>Data Transfer: <code>lw, sw, lb, sb, lbu</code></li>
<li>Branching: <code>beq, bne, bge, blt, jal, j, jalr, jr;</code></li>
<li>Bitwise: <code>and, or, xor, andi, ori, xori</code></li>
<li>Shifting: <code>sll, srl, sra, slli, srli, srai</code><br>(i &#x3D; “immediate” constant integer)</li>
</ul>
</li>
</ul>
<h1 id="Sign-Extension-Practice"><a href="#Sign-Extension-Practice" class="headerlink" title="Sign Extension Practice"></a>Sign Extension Practice</h1><h2 id="Sign-in-Two’s-Complement"><a href="#Sign-in-Two’s-Complement" class="headerlink" title="Sign in Two’s Complement"></a>Sign in Two’s Complement</h2><p>How do we know if a binary two’s complement number is negative?</p>
<ul>
<li>Look at the most significant bit!</li>
</ul>
<h2 id="Sign-Extension"><a href="#Sign-Extension" class="headerlink" title="Sign Extension"></a>Sign Extension</h2><p>If we want to take an 8-bit two’s complement number and make it a 9-bit number, how would we do so?</p>
<ul>
<li>We replicate the most significant bit!</li>
</ul>
<p>e.g.<br>0b0000 0010(+2) -&gt; 0b0 0000 0010(+2)<br>0b1111 1110 (-2) -&gt; 0b1 1111 1110 (-2)</p>
<h2 id="Arithmetic-Sign-Extension"><a href="#Arithmetic-Sign-Extension" class="headerlink" title="Arithmetic Sign Extension"></a>Arithmetic Sign Extension</h2><p>When doing math, immediate values are sign extended.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># -1 = 0xFFF </span><br><span class="line">addi t0, x0, -1      # t0-&gt;[-1]-&gt;[0xFFFFFFFF]</span><br><span class="line">addi t0, x0, 0x0FF   # t0-&gt;[0x000000FF]</span><br><span class="line">addi t0, x0, 0xF77   # t0-&gt;[0xFFFFFF77]</span><br></pre></td></tr></table></figure>

<h2 id="Loading-Sign-Extension"><a href="#Loading-Sign-Extension" class="headerlink" title="Loading Sign Extension"></a>Loading Sign Extension</h2><ul>
<li>For assembly, this happens when we pull data out of memory </li>
<li>Byte in memory: 0b1111 1110 (-2) </li>
<li>load byte -&gt; Register contents:<br>  0b <em>XXXX XXXX XXXX XXXX XXXX XXXX</em> 1111 1110 What do we do with the X values?<br>  <strong>Sign extend!</strong><br>  0b <em>1111 1111 1111 1111 1111 1111</em> 1111 1110</li>
</ul>
<p>Normal (signed) loads sign extend the most significant bit </p>
<ul>
<li><p>Memory: 0b1000 1111<br>  Load Byte -&gt; 0b1111 1111 1111 1111 1111 1111 1000 1111</p>
</li>
<li><p>Memory: 0b0000 1111<br>  Load Byte -&gt; 0b0000 0000 0000 0000 0000 0000 0000 1111</p>
</li>
</ul>
<p>Offset loads also sign extend:<br>    Memory &#x3D; <code>[0x00008011]</code> (address in s0)<br>    Assume system is little endian<br>        lb t0, 0(s0) -&gt; loading 0b00010001<br>            0b0000 0000 0000 0000 0000 0000 0001 000<br>        lb t0, 1(s0) -&gt; loading 0b10000000<br>            0b1111 1111 1111 1111 1111 1111 1000 0000<br>        lbu t0, 1(s0) -&gt; loading 0b10000000<br>            0b0000 0000 0000 0000 0000 0000 1000 0000</p>
<h1 id="Pseudo-Instructions"><a href="#Pseudo-Instructions" class="headerlink" title="Pseudo-Instructions"></a>Pseudo-Instructions</h1><h2 id="Assembly-Instructions"><a href="#Assembly-Instructions" class="headerlink" title="Assembly Instructions"></a>Assembly Instructions</h2><ul>
<li>A low-level programming language where the program instructions match a particular architecture’s operations<ul>
<li>Code can be compiled into different assembly languages, but an assembly language can only run on hardware that supports it</li>
</ul>
</li>
<li>But sometimes, for the programmer’s benefit, it’s useful to have additional instructions that aren’t really implemented by the hardware<ul>
<li>Instead translated into real instructions</li>
</ul>
</li>
<li>Example:            mv dst,reg1<br>translates into:  addi dst,reg1,0</li>
</ul>
<h2 id="More-Pseudo-Instruction"><a href="#More-Pseudo-Instruction" class="headerlink" title="More Pseudo-Instruction"></a>More Pseudo-Instruction</h2><ul>
<li>Load Immediate (li)<ul>
<li><code>li dst, im</code></li>
<li>Loads 32-bit immediate into <code>dst</code></li>
<li>utilizes: <code>addi, lui</code>(load upper immediate)</li>
</ul>
</li>
<li>Load Address (<code>la</code>)<ul>
<li><code>la dst, label</code></li>
<li>Loads address of specified label into <code>dst</code></li>
<li>translates to: <code>auipc dst, &lt;offset to label&gt;</code>(add upper immediate program counter)</li>
</ul>
</li>
<li>No Operation(nop)<ul>
<li><code>nop</code></li>
<li>Do nothing</li>
<li>translates to: <code>addi x0, x0, 0</code></li>
</ul>
</li>
</ul>
<h2 id="Pseudo-Instructions-are-useful"><a href="#Pseudo-Instructions-are-useful" class="headerlink" title="Pseudo-Instructions are useful"></a>Pseudo-Instructions are useful</h2><ul>
<li>Even the<code>j</code> instruction is actually a pseudo-Instruction<ul>
<li>We will see what this converts to later this lecture</li>
</ul>
</li>
<li>Pseudo-Instructions are core to writing RISC assembly code and you will see them in any RISC assembly code you read</li>
</ul>
<p>Full list of RISC-V supported pseudo instructions is on the greensheet </p>
<h1 id="C-to-RISC-V-Practice"><a href="#C-to-RISC-V-Practice" class="headerlink" title="C to RISC-V Practice"></a>C to RISC-V Practice</h1><blockquote>
<p>Keep in mind that whenever you are changing C to RISCV, the number one thing you should keep in mind that you should write everything out step by step and you convert that line by line to do your proper RISCV instructions. And at the very end, if you see an opportunity, you can clean it up(sharpen your code)</p>
</blockquote>
<ul>
<li><p>Let’s put our all of our new RISC-V knowledge to use in an example: “Fast String Copy” </p>
</li>
<li><p>C code is as follows:<br>  <code>/* Copy string from p to q */</code><br>  <code>char *p, *q;</code><br>  <code>while((*q++ = *p++) != ‘\0’) ; </code></p>
</li>
<li><p>What do we know about its structure?</p>
<ul>
<li>Single <code>while</code> loop</li>
<li>Exit condition is an equality test</li>
</ul>
</li>
<li><p>Start with code skeleton:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># copy String p to q</span><br><span class="line"># p-&gt;s0, q-&gt;s1 (char* pointers)</span><br><span class="line">Loop: lb    t0, 0(s0)      # t0 = *p</span><br><span class="line">      sb    t0, 0(s1)      # *q = t0</span><br><span class="line">      addi  s0, s0, 1      # p = p + 1</span><br><span class="line">      addi  s1, s1, 1      # q = q + q</span><br><span class="line">      beq   t0, x0, Exit   # if *p==0, go to Exit</span><br><span class="line">      j Loop               # go to Loop</span><br><span class="line">Exit: # N chars in p =&gt; N*6 instructions</span><br></pre></td></tr></table></figure></li>
<li><p>In <code>lb    t0, 0(s0) </code> what if <code>lb</code> sign extends?</p>
<ul>
<li>Not a problem because <code>sb</code> only writes a single byte.(The sign extension is ignored)</li>
</ul>
</li>
</ul>
<p>• Alternate code using bne:(optimize)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># copy String p to q </span><br><span class="line"># p→s0, q→s1 (char* pointers) </span><br><span class="line">Loop: lb   t0,0(s0)     # t0 = *p</span><br><span class="line">	  sb   t0,0(s1)     # *q = t0</span><br><span class="line">	  addi s0,s0,1      # p = p + 1</span><br><span class="line">	  addi s1,s1,1      # q = q + 1</span><br><span class="line">	  bne t0,x0,Loop    # if *p==0, go to Loop </span><br><span class="line">Exit: # N chars in p =&gt; N*5 instructions</span><br></pre></td></tr></table></figure>

<h1 id="Functions-in-Assembly"><a href="#Functions-in-Assembly" class="headerlink" title="Functions in Assembly"></a>Functions in Assembly</h1><h2 id="Six-Steps-of-Calling-a-Function"><a href="#Six-Steps-of-Calling-a-Function" class="headerlink" title="Six Steps of Calling a Function"></a>Six Steps of Calling a Function</h2><ol>
<li>Put arguments in a place where the function can access them </li>
<li>Transfer control to the function </li>
<li>The function will acquire any (local) storage resources it needs </li>
<li>The function performs its desired task \</li>
<li>The function puts return value in an accessible place and “cleans up” </li>
<li>Control is returned to you</li>
</ol>
<h2 id="1-and-5-Where-should-we-put-the-arguments-and-return-values"><a href="#1-and-5-Where-should-we-put-the-arguments-and-return-values" class="headerlink" title="1 and 5: Where should we put the arguments and return values?"></a>1 and 5: Where should we put the arguments and return values?</h2><ul>
<li>Registers way faster than memory, so use them whenever possible </li>
<li>a0–a7: eight argument registers to pass parameters </li>
<li>a0–a1: two argument registers also used to return values<ul>
<li>Order of arguments matters</li>
<li>If need extra space, use memory (the stack!)</li>
</ul>
</li>
</ul>
<h3 id="Example-function-in-assembly"><a href="#Example-function-in-assembly" class="headerlink" title="Example: function in assembly"></a>Example: function in assembly</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123; </span><br><span class="line">	a = <span class="number">3</span>; </span><br><span class="line">	b = a+<span class="number">1</span>; </span><br><span class="line">	a = add(a, b); </span><br><span class="line">	... </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123; </span><br><span class="line">	<span class="keyword">return</span> a+b; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">main: </span><br><span class="line">	addi a0, x0, 3 </span><br><span class="line">	addi a1, a0, 1 </span><br><span class="line">	jal ra, add </span><br><span class="line">	... </span><br><span class="line">add:</span><br><span class="line">	add a0, a0, a1 </span><br><span class="line">	jr ra</span><br></pre></td></tr></table></figure>

<h3 id="More-Registers"><a href="#More-Registers" class="headerlink" title="More Registers"></a>More Registers</h3><ul>
<li><code>a0–a7</code>: eight argument registers to pass parameters </li>
<li><code>a0–a1</code>: two registers to return values </li>
<li><code>sp</code>: “stack pointer”<ul>
<li>Holds the current memory address of the “bottom” of the stack</li>
</ul>
</li>
</ul>
<h2 id="2-and-6-How-do-we-Transfer-Control"><a href="#2-and-6-How-do-we-Transfer-Control" class="headerlink" title="2 and 6: How do we Transfer Control?"></a>2 and 6: How do we Transfer Control?</h2><ul>
<li>Jump(j)<ul>
<li>j label</li>
</ul>
</li>
<li>Jump and Link (jal)  (Used to invoke a function)<ul>
<li>jal dst label</li>
</ul>
</li>
<li>Jump and Link Register (jalr)  (Used to invoke a function)<ul>
<li>jalr dst src imm</li>
</ul>
</li>
<li>“and Link”: Saves the location of instruction in a register before jumping </li>
<li>Jump Register (jr) – jr src   (Used to return from a function(src &#x3D; ra))</li>
<li>ra &#x3D; return address register, used to save where a function is called from so we can get back</li>
</ul>
<h3 id="Function-Call-Example"><a href="#Function-Call-Example" class="headerlink" title="Function Call Example"></a>Function Call Example</h3><p><img src="/pic/CS61C/More-RISCV/1.png" alt="1"><br><img src="/pic/CS61C/More-RISCV/2.png" alt="2"></p>
<ul>
<li><p>How do we get back?</p>
<blockquote>
<p>Well, option one is that we could always put a label here at address 1016, and we can just j back to that label. But that kind of annoying and ugly because that means that for every single time we are going to make a funcion we need to write a new label which is really annoying and not that clean.<br>So instead, let’s try to use a memory address.This means for instructions like jal and jalr, instead of using the label, they look at a register, and <strong>this register should hold an address of where you want to jump to</strong> so <strong>before jumping into a function, you need to put the address of the instruction that you want to come back to into <code>ra</code> register.</strong> So ra stands for return address, because when you return from the function, you want to return to that address</p>
</blockquote>
</li>
<li><p>Would we know this before compiling?</p>
<blockquote>
<p>Both for accessibility reasons and for security reasons it’s good that you don’t. So how can we fix this problem?<br>Well, this is why we introduced the <code>jal</code> function. <code>jal</code> stands for jump and link. Jump is jumping to somewhere. Link is linking the return address. And what is the return address should be? When we link, what’s happening is we’re actually putting the address of the next instruction inside of this register.<br>What <code>jal</code> or <code>jalr</code> does is, the first thing that is does is it takes the current pc (program counter) and it adds four. And then it puts that address inside of this register.<br>Why does it adds four? Memory is byte addressed, and every RISCV instruction is one word (or four bytes) long.</p>
</blockquote>
</li>
</ul>
<h3 id="J-is-a-pseudo-instruction-explained"><a href="#J-is-a-pseudo-instruction-explained" class="headerlink" title="J is a pseudo-instruction explained"></a>J is a pseudo-instruction explained</h3><ul>
<li><code>jal</code> syntax: <code>jal dst label</code> </li>
<li>You supply the register used to link<ul>
<li>When calling a function you use ra</li>
</ul>
</li>
<li>What happens if you specify x0?<ul>
<li><code>jal x0 label</code></li>
<li><code>x0</code> always contains 0, so attempts to write to it do nothing</li>
<li>So jal x0 label is just jumping without linking</li>
</ul>
</li>
<li><code>j label</code> is a pseudo-instruction for <code>jal x0 label</code><ul>
<li>Similarly <code>jr</code> is a pseudo-instruction for <code>jalr</code> following the same idea</li>
</ul>
</li>
</ul>
<h3 id="Review-Question"><a href="#Review-Question" class="headerlink" title="Review Question"></a>Review Question</h3><p><img src="/pic/CS61C/More-RISCV/3.png" alt="3"></p>
<ul>
<li>A: Invalid Syntax(<code>jal</code> requires a label)</li>
<li>B: Invalid Syntax(branch requires a label)</li>
<li>C: Correct !</li>
<li>D: Invalid Syntax(<code>j</code> requires a label)</li>
<li>E: Would return properly though it would overwrite ra after doing so</li>
</ul>
<h2 id="3-Local-storage-for-variables"><a href="#3-Local-storage-for-variables" class="headerlink" title="3: Local storage for variables"></a>3: Local storage for variables</h2><ul>
<li>Stack pointer (sp) holds the address of the bottom of the stack<ul>
<li>Decrement it (recall stack grows downwards)</li>
<li>Then use store word to write to a variable</li>
<li>To “clean up”, just increment the stack pointer</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># store t0 to the stack </span><br><span class="line">addi sp, sp, -4 </span><br><span class="line">sw t0, 0(sp)</span><br></pre></td></tr></table></figure>

<h1 id="Function-Calling-Conventions"><a href="#Function-Calling-Conventions" class="headerlink" title="Function Calling Conventions"></a>Function Calling Conventions</h1><h2 id="Which-registers-can-we-use"><a href="#Which-registers-can-we-use" class="headerlink" title="Which registers can we use?"></a>Which registers can we use?</h2><ul>
<li>Problem: how does the function know which registers are safe to use?</li>
</ul>
<p><img src="/pic/CS61C/More-RISCV/4.png" alt="4"><br>Function A may have been using t0 when it called Function B!</p>
<h3 id="Example-sumSquare"><a href="#Example-sumSquare" class="headerlink" title="Example: sumSquare"></a>Example: sumSquare</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sumSquare</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123; </span><br><span class="line">	<span class="keyword">return</span> mult(x,x)+ y; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>What do we need to save?<ul>
<li>Call to <code>mult</code> will overwrite <code>ra</code>, so save it</li>
<li>Reusing <code>a1</code> to pass 2nd argument to <code>mult</code>, but need current value (<code>y</code>) later, so save <code>a1</code></li>
</ul>
</li>
</ul>
<h2 id="Calling-Conventions"><a href="#Calling-Conventions" class="headerlink" title="Calling Conventions"></a>Calling Conventions</h2><ul>
<li><p>Calle<strong>R</strong>: the calling function </p>
</li>
<li><p>Calle<strong>E</strong>: the function being called</p>
</li>
<li><p>Register Conventions: A set of generally accepted rules as to which registers will be unchanged after a procedure call (<code>jal</code>) and which may have changed</p>
</li>
</ul>
<h3 id="Caller-and-Callee"><a href="#Caller-and-Callee" class="headerlink" title="Caller and Callee"></a>Caller and Callee</h3><p><img src="/pic/CS61C/More-RISCV/5.png" alt="5"></p>
<h2 id="Saved-Register-Callee-Saved"><a href="#Saved-Register-Callee-Saved" class="headerlink" title="Saved Register (Callee Saved)"></a>Saved Register (Callee Saved)</h2><ul>
<li>These registers are expected to be the same before and after a function call<ul>
<li>If calle<strong>E</strong> uses them, it must <strong>restore values before returning</strong></li>
<li>This means save the old values, use the registers, then reload the old values back into the registers</li>
</ul>
</li>
<li>s0-s11(saved registers) </li>
<li>sp(stack pointer)<ul>
<li>If not in same place, the caller won’t be able to properly access its own stack variables</li>
</ul>
</li>
</ul>
<blockquote>
<p>You should be putting important values in the S registers.However both the caller and the callee might be using the s registers. How can we resolve this conflict of interest?<br>Well, <strong>the first thing that the Callee should do before starts executing any of its code is it should save any of the s registers that is wishes to use on the stack.</strong> This means the caller have some important value in the s registers and it wants to make sure and it nervous that if it calls a function that is going to override it. The callee is smart and says “Don’t worry,everything will seem fine.” The callee wants to use the <code>s0</code>-<code>s11</code>, but sees that its caller is also using them. So the callee will take the caller’s value of <code>s0</code>-<code>s1</code> and put them on the stack. And then the callee is free to use <code>s0</code>-<code>s11</code> . Then, <strong>right before function B returns control back, it will bring those values back into s registers.</strong> And then it will immediately return back to the caller.</p>
</blockquote>
<h2 id="Volatile-Registers-Caller-Saved"><a href="#Volatile-Registers-Caller-Saved" class="headerlink" title="Volatile Registers (Caller Saved)"></a>Volatile Registers (Caller Saved)</h2><ul>
<li>These registers can be freely changed by the calle<strong>E</strong><ul>
<li>If calle<strong>R</strong> needs them, it must save those values before making a procedure call</li>
</ul>
</li>
<li>t0-t6(temporary registers) </li>
<li>a0-a7(return address and arguments) </li>
<li>ra(return address)<ul>
<li>These will change if calle<strong>E</strong> invokes another function (nested function means calle<strong>E</strong> is also a calle<strong>R</strong>)</li>
</ul>
</li>
</ul>
<blockquote>
<p>If the caller cares about the argument registers, then it should save it’s values (or registers) before it calls the function. In addition, we also have the <code>ra</code> register as well.The caller wants to make sure that it’s not going to be get and overwritten by a future function.<br>So above are registers that can be freely changed by the callee because caller already saved them</p>
</blockquote>
<h2 id="Register-Conventions"><a href="#Register-Conventions" class="headerlink" title="Register Conventions"></a>Register Conventions</h2><p>Each register is one of two types: </p>
<ul>
<li>Caller saved<ul>
<li>The callee function can use them freely<br>   (if needed, the caller had to save them before invoking and will restore them afterwards)</li>
</ul>
</li>
<li>Callee saved<ul>
<li>The callee function must save them before modifying them, and restore them before returning (avoid using them at all, and no need to save)</li>
</ul>
</li>
</ul>
<p>This is a contract agreed upon by all functions</p>
<h2 id="Calling-Convention-on-Greencard"><a href="#Calling-Convention-on-Greencard" class="headerlink" title="Calling Convention on Greencard"></a>Calling Convention on Greencard</h2><p><img src="/pic/CS61C/More-RISCV/6.png" alt="6"></p>
<h2 id="How-do-we-save-registers-The-stack"><a href="#How-do-we-save-registers-The-stack" class="headerlink" title="How do we save registers? The stack!"></a>How do we save registers? The stack!</h2><p><img src="/pic/CS61C/More-RISCV/7.png" alt="7"></p>
<h3 id="Stack-Before-During-After-Call"><a href="#Stack-Before-During-After-Call" class="headerlink" title="Stack Before, During, After Call"></a>Stack Before, During, After Call</h3><p><img src="/pic/CS61C/More-RISCV/8.png" alt="8"><br><img src="/pic/CS61C/More-RISCV/9.png" alt="9"><br><img src="/pic/CS61C/More-RISCV/10.png" alt="10"></p>
<h2 id="Basic-Structure-of-a-Function"><a href="#Basic-Structure-of-a-Function" class="headerlink" title="Basic Structure of a Function"></a>Basic Structure of a Function</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Prologue </span><br><span class="line">	func_label: </span><br><span class="line">	addi sp,sp, -framesize </span><br><span class="line">	sw ra, &lt;framesize-4&gt;(sp) </span><br><span class="line">	#store other callee saved registers </span><br><span class="line">	#save other regs if need be </span><br><span class="line">Body    (call other functions…)</span><br><span class="line">	… </span><br><span class="line">Epilogue</span><br><span class="line">	#restore other regs if need be  </span><br><span class="line">	#restore other callee saved registers </span><br><span class="line">	lw ra, &lt;framesize-4&gt;(sp) </span><br><span class="line">	addi sp,sp, framesize </span><br><span class="line">	jr ra</span><br></pre></td></tr></table></figure>

<h2 id="Stack-during-function-execution"><a href="#Stack-during-function-execution" class="headerlink" title="Stack during function execution"></a>Stack during function execution</h2><ul>
<li>Need to save old values of s0 and s1<br><img src="/pic/CS61C/More-RISCV/11.png" alt="11"></li>
</ul>
<h2 id="Example-Using-Saved-Registers"><a href="#Example-Using-Saved-Registers" class="headerlink" title="Example: Using Saved Registers"></a>Example: Using Saved Registers</h2><p><img src="/pic/CS61C/More-RISCV/12.png" alt="12"></p>
<h2 id="Example-Using-Volatile-Registers"><a href="#Example-Using-Volatile-Registers" class="headerlink" title="Example: Using Volatile Registers"></a>Example: Using Volatile Registers</h2><p><img src="/pic/CS61C/More-RISCV/13.png" alt="13"></p>
<h2 id="Register-Conventions-Summary"><a href="#Register-Conventions-Summary" class="headerlink" title="Register Conventions Summary"></a>Register Conventions Summary</h2><ul>
<li>One more time for luck:<ul>
<li>Calle<strong>R</strong> must save any <strong>volatile</strong> registers it is using onto the stack before making a procedure call</li>
<li>Calle<strong>R</strong> can trust <strong>saved</strong> registers to maintain values</li>
<li>Calle<strong>E</strong> must “save” any <strong>saved</strong> registers it intends to use by putting them on the stack before overwriting their values</li>
</ul>
</li>
<li>Notes:<ul>
<li>Calle<strong>R</strong> and calle<strong>E</strong> only need to save the appropriate registers they are using (not all!)</li>
<li>Don’t forget to restore the values later</li>
</ul>
</li>
</ul>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><h2 id="Example-function-with-calling-convention"><a href="#Example-function-with-calling-convention" class="headerlink" title="Example function with calling convention"></a>Example function with calling convention</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Leaf</span><span class="params">(<span class="type">int</span> g, <span class="type">int</span> h, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123; </span><br><span class="line">	<span class="type">int</span> f; </span><br><span class="line">	f = (g+h)-(i+j); </span><br><span class="line">	<span class="keyword">return</span> f; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Leaf: </span><br><span class="line">addi sp,sp,-8 </span><br><span class="line"># allocate stack </span><br><span class="line">sw s1,4(sp) # save s1 </span><br><span class="line">sw s0,0(sp) # save s0 </span><br><span class="line"></span><br><span class="line">add s0,a0,a1 # s0 = g+h </span><br><span class="line">add s1,a2,a3 # s1 = i+j </span><br><span class="line">sub a0,s0,s1 </span><br><span class="line"># return value a0 = s0-s1 </span><br><span class="line"></span><br><span class="line">lw s0,0(sp) # restore s0 </span><br><span class="line">lw s1,4(sp) # restore s1 </span><br><span class="line">addi sp,sp,8 # free stack </span><br><span class="line">jr ra # return</span><br></pre></td></tr></table></figure>

<h2 id="Choosing-Your-Registers"><a href="#Choosing-Your-Registers" class="headerlink" title="Choosing Your Registers"></a>Choosing Your Registers</h2><ul>
<li>Minimize register footprint<ul>
<li>Optimize to reduce number of registers you need to save by choosing which registers to use in a function</li>
<li>Only save when you absolutely have to</li>
</ul>
</li>
<li>Function does NOT call another function<ul>
<li>Use only <code>t0-t6</code> and there is nothing to save!</li>
</ul>
</li>
<li>Function calls other function(s)<ul>
<li>Values you need throughout go in <code>s0-s11</code>, others go in <code>t0-t6</code></li>
<li>At each function call, check number arguments and return values for whether you or not you need to save</li>
</ul>
</li>
</ul>
<h2 id="Different-register-choices-could-reduce-effort"><a href="#Different-register-choices-could-reduce-effort" class="headerlink" title="Different register choices could reduce effort"></a>Different register choices could reduce effort</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Leaf</span><span class="params">(<span class="type">int</span> g, <span class="type">int</span> h, <span class="type">int</span> i, <span class="type">int</span> j)</span> &#123; </span><br><span class="line">	<span class="type">int</span> f; </span><br><span class="line">	f = (g+h)-(i+j); </span><br><span class="line">	<span class="keyword">return</span> f; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Leaf: </span><br><span class="line"># nothing to save on stack </span><br><span class="line">add t0,a0,a1 # t0 = g+h </span><br><span class="line">add t1,a2,a3 # t1 = i+j </span><br><span class="line">sub a0,t0,t1 </span><br><span class="line"># return value a0 = t0-t1 </span><br><span class="line"># nothing to restore from stack </span><br><span class="line">jr ra        # return</span><br></pre></td></tr></table></figure>

<p>Be lazy! Use register choices that minimize saving to the stack. It makes your program faster too…</p>
<h2 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h2><ul>
<li><p>Pseudo-instructions </p>
</li>
<li><p>Functions is assembly</p>
<ul>
<li>Six steps of calling a function <ol>
<li>Place arguments</li>
<li>Jump to function </li>
<li>Create local storage (Prologue)</li>
<li>Perform desired task</li>
<li>Place return value and clean up storage (Epilogue) </li>
<li>Jump back to caller</li>
</ol>
</li>
</ul>
</li>
<li><p>Calling conventions</p>
<ul>
<li>Need a method for knowing which registers can be trusted across function calls</li>
<li>Caller-saved registers (Volatile Registers) <ul>
<li>Saved by caller if needed </li>
<li>Free to use by callee</li>
</ul>
</li>
<li>Callee-saved registers (Saved Registers) <ul>
<li>Saved by callee if needed </li>
<li>Safe across function calls for caller</li>
</ul>
</li>
</ul>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://vks-feng.github.io/">Vks</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://vks-feng.github.io/">https://vks-feng.github.io/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">此文章版权归Vks所有，如有转载，请注明来自原作者</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cs61c/">cs61c</a></div><div class="post_share"><div class="social-share" data-image="/img/VksAvatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/08/04/Introduction-to-Machine-Language%E2%80%94%E2%80%94RISC-V/" title="Introduction to Machine Language——RISC-V"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Introduction to Machine Language——RISC-V</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/07/28/C-Introduction-Pointers/" title="C-Introduction,Pointers"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-28</div><div class="title">C-Introduction,Pointers</div></div></a></div><div><a href="/2024/07/28/Number-Representation/" title="Number Representation"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-28</div><div class="title">Number Representation</div></div></a></div><div><a href="/2024/08/01/C-Arrays-Strings-More-Pointers/" title="C Arrays,Strings,More Pointers"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-01</div><div class="title">C Arrays,Strings,More Pointers</div></div></a></div><div><a href="/2024/08/02/C-Memory-Management-and-Usage/" title="C-Memory Management and Usage"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-02</div><div class="title">C-Memory Management and Usage</div></div></a></div><div><a href="/2024/08/03/Floating-Point/" title="Floating Point"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-03</div><div class="title">Floating Point</div></div></a></div><div><a href="/2024/08/04/Introduction-to-Machine-Language%E2%80%94%E2%80%94RISC-V/" title="Introduction to Machine Language——RISC-V"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-04</div><div class="title">Introduction to Machine Language——RISC-V</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/VksAvatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Vks</div><div class="author-info__description">志之所趋，无远弗届</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Vks-Feng"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Vks-Feng" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:vksfeng@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Welcome to my blog!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Review-of-Last-Lecture"><span class="toc-number">1.</span> <span class="toc-text">Review of Last Lecture</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sign-Extension-Practice"><span class="toc-number">2.</span> <span class="toc-text">Sign Extension Practice</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Sign-in-Two%E2%80%99s-Complement"><span class="toc-number">2.1.</span> <span class="toc-text">Sign in Two’s Complement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sign-Extension"><span class="toc-number">2.2.</span> <span class="toc-text">Sign Extension</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Arithmetic-Sign-Extension"><span class="toc-number">2.3.</span> <span class="toc-text">Arithmetic Sign Extension</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loading-Sign-Extension"><span class="toc-number">2.4.</span> <span class="toc-text">Loading Sign Extension</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pseudo-Instructions"><span class="toc-number">3.</span> <span class="toc-text">Pseudo-Instructions</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Assembly-Instructions"><span class="toc-number">3.1.</span> <span class="toc-text">Assembly Instructions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#More-Pseudo-Instruction"><span class="toc-number">3.2.</span> <span class="toc-text">More Pseudo-Instruction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pseudo-Instructions-are-useful"><span class="toc-number">3.3.</span> <span class="toc-text">Pseudo-Instructions are useful</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C-to-RISC-V-Practice"><span class="toc-number">4.</span> <span class="toc-text">C to RISC-V Practice</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Functions-in-Assembly"><span class="toc-number">5.</span> <span class="toc-text">Functions in Assembly</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Six-Steps-of-Calling-a-Function"><span class="toc-number">5.1.</span> <span class="toc-text">Six Steps of Calling a Function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-and-5-Where-should-we-put-the-arguments-and-return-values"><span class="toc-number">5.2.</span> <span class="toc-text">1 and 5: Where should we put the arguments and return values?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-function-in-assembly"><span class="toc-number">5.2.1.</span> <span class="toc-text">Example: function in assembly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#More-Registers"><span class="toc-number">5.2.2.</span> <span class="toc-text">More Registers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-and-6-How-do-we-Transfer-Control"><span class="toc-number">5.3.</span> <span class="toc-text">2 and 6: How do we Transfer Control?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Function-Call-Example"><span class="toc-number">5.3.1.</span> <span class="toc-text">Function Call Example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#J-is-a-pseudo-instruction-explained"><span class="toc-number">5.3.2.</span> <span class="toc-text">J is a pseudo-instruction explained</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Review-Question"><span class="toc-number">5.3.3.</span> <span class="toc-text">Review Question</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Local-storage-for-variables"><span class="toc-number">5.4.</span> <span class="toc-text">3: Local storage for variables</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Function-Calling-Conventions"><span class="toc-number">6.</span> <span class="toc-text">Function Calling Conventions</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Which-registers-can-we-use"><span class="toc-number">6.1.</span> <span class="toc-text">Which registers can we use?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-sumSquare"><span class="toc-number">6.1.1.</span> <span class="toc-text">Example: sumSquare</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Calling-Conventions"><span class="toc-number">6.2.</span> <span class="toc-text">Calling Conventions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Caller-and-Callee"><span class="toc-number">6.2.1.</span> <span class="toc-text">Caller and Callee</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Saved-Register-Callee-Saved"><span class="toc-number">6.3.</span> <span class="toc-text">Saved Register (Callee Saved)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Volatile-Registers-Caller-Saved"><span class="toc-number">6.4.</span> <span class="toc-text">Volatile Registers (Caller Saved)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Register-Conventions"><span class="toc-number">6.5.</span> <span class="toc-text">Register Conventions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Calling-Convention-on-Greencard"><span class="toc-number">6.6.</span> <span class="toc-text">Calling Convention on Greencard</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-do-we-save-registers-The-stack"><span class="toc-number">6.7.</span> <span class="toc-text">How do we save registers? The stack!</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Stack-Before-During-After-Call"><span class="toc-number">6.7.1.</span> <span class="toc-text">Stack Before, During, After Call</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-Structure-of-a-Function"><span class="toc-number">6.8.</span> <span class="toc-text">Basic Structure of a Function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stack-during-function-execution"><span class="toc-number">6.9.</span> <span class="toc-text">Stack during function execution</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-Using-Saved-Registers"><span class="toc-number">6.10.</span> <span class="toc-text">Example: Using Saved Registers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-Using-Volatile-Registers"><span class="toc-number">6.11.</span> <span class="toc-text">Example: Using Volatile Registers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Register-Conventions-Summary"><span class="toc-number">6.12.</span> <span class="toc-text">Register Conventions Summary</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Summary"><span class="toc-number">7.</span> <span class="toc-text">Summary</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-function-with-calling-convention"><span class="toc-number">7.1.</span> <span class="toc-text">Example function with calling convention</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Choosing-Your-Registers"><span class="toc-number">7.2.</span> <span class="toc-text">Choosing Your Registers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Different-register-choices-could-reduce-effort"><span class="toc-number">7.3.</span> <span class="toc-text">Different register choices could reduce effort</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary-1"><span class="toc-number">7.4.</span> <span class="toc-text">Summary</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/05/More-RISC-V-RISC-V-Functions/" title="More RISC-V,RISC-V Functions">More RISC-V,RISC-V Functions</a><time datetime="2024-08-05T14:48:47.000Z" title="发表于 2024-08-05 22:48:47">2024-08-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/04/Introduction-to-Machine-Language%E2%80%94%E2%80%94RISC-V/" title="Introduction to Machine Language——RISC-V">Introduction to Machine Language——RISC-V</a><time datetime="2024-08-04T13:22:42.000Z" title="发表于 2024-08-04 21:22:42">2024-08-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/03/Floating-Point/" title="Floating Point">Floating Point</a><time datetime="2024-08-03T09:10:24.000Z" title="发表于 2024-08-03 17:10:24">2024-08-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/02/C-Memory-Management-and-Usage/" title="C-Memory Management and Usage">C-Memory Management and Usage</a><time datetime="2024-08-02T08:21:26.000Z" title="发表于 2024-08-02 16:21:26">2024-08-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/01/C-Arrays-Strings-More-Pointers/" title="C Arrays,Strings,More Pointers">C Arrays,Strings,More Pointers</a><time datetime="2024-08-01T10:58:38.000Z" title="发表于 2024-08-01 18:58:38">2024-08-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 By Vks</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'm9pkoaM51rwmIpdPUDukvQQj-MdYXbMMI',
      appKey: 'YLQGj1L2xfuW0PeDPDsF20Bq',
      avatar: 'monsterid',
      serverURLs: 'https://m9pkoam5.api.lncldglobal.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>